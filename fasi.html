<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Fasi di Lavoro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; text-align: center; background: #f9f9f9; margin: 0; padding: 20px; }
#faseImage { max-width: 250px; margin: 15px auto; display: block; }
button { display: block; width: 80%; max-width: 300px; margin: 15px auto; padding: 16px; font-size: 18px; border: none; border-radius: 12px; background: #4CAF50; color: white; font-weight: bold; cursor: pointer; }
button.hidden { display: none; }
#timer { font-size: 40px; margin: 20px 0; font-weight: bold; color: #333; }
#totalTimer { font-size: 22px; margin: 10px 0; color: #555; }
#faseCorrente { font-size: 22px; font-weight: bold; margin: 15px 0; }
.alert { background: #ffe08a; padding: 15px; margin: 20px auto; border-radius: 12px; max-width: 320px; font-size: 18px; font-weight: bold; }
.hidden { display: none; }
#progressContainer { width: 90%; height: 20px; background: #ddd; border-radius: 10px; margin: 20px auto; overflow: hidden; }
#progressBar { height: 100%; width: 0%; background: #4CAF50; }
#log { text-align: left; margin-top: 20px; font-size: 14px; }
table { border-collapse: collapse; margin: 20px auto; width: 90%; max-width: 500px; }
table, th, td { border: 1px solid #666; padding: 6px; text-align: center; font-size: 14px; }
th { background: #ddd; }
.blink { animation: blink 1s step-start infinite; color: red; }
@keyframes blink { 50% { color: transparent; } }
#restartBtn { font-size: 12px; margin-top: 20px; background: #888; }
</style>
</head>
<body>

<div id="faseCorrente">Fase attuale: --</div>
<img id="faseImage" src="preriscaldo.png" alt="Fase in corso">
<button id="btnPreriscaldo">üî• Avvia Preriscaldo (1m45s)</button>
<button id="btnColatura" class="hidden">‚öôÔ∏è Avvia Colatura (30m)</button>
<div id="timer">--</div>
<div id="totalTimer" class="hidden">Tempo totale colatura: 0m0s</div>
<div id="progressContainer"><div id="progressBar"></div></div>
<div id="avviso" class="alert hidden"></div>
<button id="btnConferma" class="hidden">‚úÖ Conferma Operazione</button>

<div id="log"><h3>üìú Orari delle Fasi</h3></div>

<table id="riepilogo">
<thead><tr><th>Fase</th><th>Tempo programmato</th><th>Tempo effettivo</th></tr></thead>
<tbody>
<tr><td>Preriscaldo</td><td>1m45s</td><td id="effPreriscaldo">--</td></tr>
<tr><td>Colatura</td><td>30m</td><td id="effColatura">--</td></tr>
<tr><td>Tranciare</td><td>+5m30s</td><td id="effTrancia">--</td></tr>
<tr><td>Smerigliatura</td><td>Fine</td><td id="effSmeriglia">--</td></tr>
</tbody>
</table>

<button id="restartBtn">üîÑ Rinizia da capo</button>

<audio id="beep" src="beep.mp3" loop></audio>
<audio id="siren" src="siren.mp3" loop></audio>

<script>
let timerEl = document.getElementById("timer");
let totalTimerEl = document.getElementById("totalTimer");
let avvisoEl = document.getElementById("avviso");
let btnConferma = document.getElementById("btnConferma");
let faseImage = document.getElementById("faseImage");
let faseCorrenteEl = document.getElementById("faseCorrente");
let beep = document.getElementById("beep");
let siren = document.getElementById("siren");

let currentInterval = null;
let faseAttuale = "";
let faseStart = 0;
let faseDurata = 0;
let tranciaTime = 0;
let colaturaStartTime = 0;
let totalColaturaTimer = null;
let faseConfermata = false;
let tranciaConfermata = false;

function formatTime(sec){ let m = Math.floor(sec/60); let s = sec%60; return `${m}m${s}s`; }

function startFase(fase, durataSec){
    clearInterval(currentInterval);
    faseAttuale = fase;
    faseStart = Date.now();
    faseDurata = durataSec * 1000;
    faseConfermata = false;
    tranciaConfermata = false;

    if(fase==="preriscaldo"){ faseCorrenteEl.textContent="Fase attuale: Preriscaldo"; faseImage.src="preriscaldo.png"; }
    if(fase==="colatura"){ 
        faseCorrenteEl.textContent="Fase attuale: Colatura"; 
        faseImage.src="colatura.png"; 
        colaturaStartTime = Date.now(); 
        tranciaTime = 330000; // 5m30s
        totalTimerEl.classList.remove("hidden"); 
        if(!totalColaturaTimer){ 
            let tot=0; 
            totalColaturaTimer=setInterval(()=>{ 
                tot++; 
                let m = Math.floor(tot/60);
                let s = tot % 60;
                totalTimerEl.textContent=`Tempo totale colatura: ${m}m${s}s`; 
            },1000); 
        } 
    }

    currentInterval = setInterval(()=>{
        let now = Date.now();
        let elapsed = now - faseStart;
        let remaining = Math.max(Math.ceil((faseDurata - elapsed)/1000),0);

        timerEl.textContent = `‚è±Ô∏è ${formatTime(remaining)}`;
        document.getElementById("progressBar").style.width = ((elapsed/faseDurata)*100)+"%";

        if(remaining<=10 && remaining>0){ timerEl.classList.add("blink"); }else{ timerEl.classList.remove("blink"); }

        if(!faseConfermata){
            if(remaining <=15 && remaining>0){ beep.play().catch(()=>{}); }
            else{ beep.pause(); beep.currentTime=0; }

            if(remaining===0){ siren.play().catch(()=>{}); 
                mostraAvviso(`‚úÖ ${fase.toUpperCase()} completato!`, fase==="preriscaldo"?"preriscaldo.png":"smeriglia.png"); 
            }
        }

        if(fase==="colatura" && elapsed>=tranciaTime && !tranciaConfermata){ 
            mostraAvviso("‚úÇÔ∏è TRANCIARE ORA!","trancia.png"); 
            faseCorrenteEl.textContent="Fase attuale: Tranciare"; 
            if(!faseConfermata){ beep.play().catch(()=>{}); }
        }
    },1000);
}

function mostraAvviso(testo,img){
    avvisoEl.textContent=testo;
    avvisoEl.classList.remove("hidden");
    btnConferma.classList.remove("hidden");
    if(img) faseImage.src=img;
}

function nascondiAvviso(keepTimer=false){
    avvisoEl.classList.add("hidden"); 
    btnConferma.classList.add("hidden"); 
    beep.pause(); beep.currentTime=0; 
    siren.pause(); siren.currentTime=0; 
    faseConfermata = true;
    if(!keepTimer){ clearInterval(currentInterval); }
}

function aggiornaLog(msg){ 
    let ora=new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}); 
    document.getElementById("log").innerHTML+=`<div>[${ora}] ${msg}</div>`; 
}

function aggiornaTabella(fase,idCell){
    let tempoEff=Math.round((Date.now()-faseStart)/1000);
    let m = Math.floor(tempoEff/60);
    let s = tempoEff % 60;
    document.getElementById(idCell).textContent = `${m}m${s}s`;
}

document.getElementById("btnPreriscaldo").addEventListener("click",()=>{
    document.getElementById("btnPreriscaldo").classList.add("hidden");
    startFase("preriscaldo",105);
    aggiornaLog("Avviato Preriscaldo");
});

document.getElementById("btnColatura").addEventListener("click",()=>{
    document.getElementById("btnColatura").classList.add("hidden");
    startFase("colatura",1800);
    aggiornaLog("Avviata Colatura");
});

btnConferma.addEventListener("click",()=>{
    if(faseAttuale==="preriscaldo"){ 
        nascondiAvviso();
        aggiornaLog("Completato Preriscaldo"); 
        aggiornaTabella("Preriscaldo","effPreriscaldo"); 
        document.getElementById("btnColatura").classList.remove("hidden"); 
    }
    else if(faseAttuale==="colatura" && !tranciaConfermata && Date.now()-colaturaStartTime>=tranciaTime){ 
        // conferma tranciare senza fermare timer principale
        tranciaConfermata=true;
        nascondiAvviso(true);
        aggiornaLog("‚úÖ TRANCIARE confermato"); 
        aggiornaTabella("Tranciare","effTrancia"); 
        faseCorrenteEl.textContent="Fase attuale: Colatura"; 
    }
    else if(faseAttuale==="colatura" && Date.now()-colaturaStartTime>=faseDurata){ 
        nascondiAvviso();
        aggiornaLog("Confermato SMERIGLIATURA"); 
        aggiornaTabella("Colatura","effColatura"); 
        aggiornaTabella("Smerigliatura","effSmeriglia"); 
        faseCorrenteEl.textContent="Fase attuale: Smerigliatura"; 
    }
});

document.getElementById("restartBtn").addEventListener("click",()=>{
    if(confirm("Stai per resettare i tempi trascorsi fino ad ora, confermi di voler iniziare una nuova saldatura?")) location.href="index.html";
});
</script>
</body>
</html>
