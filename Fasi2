<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Fasi di Lavoro - Saldatura</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; margin:20px; background:#f0f0f0; }
  #faseCorrente { font-size:22px; font-weight:bold; margin-bottom:15px; }
  .hidden { display:none; }
  .progress-container { width:80%; background:#ddd; border-radius:8px; margin:10px auto; }
  .progress-bar { height:20px; width:0%; background:black; border-radius:8px; }
  button { 
    padding:12px 20px; 
    font-size:16px; 
    margin:8px; 
    border:none; 
    border-radius:6px; 
    cursor:pointer; 
    transition: all 0.3s;
  }
  .btn-dark { background:black; color:red; }
  .btn-dark:hover { background:#222; }
  .btn-red { background:red; color:black; font-weight:bold; }
  .btn-red:hover { background:#cc0000; }
  #avviso { margin:20px; font-size:18px; font-weight:bold; color:red; }
  #log { margin-top:20px; text-align:left; max-width:600px; margin-left:auto; margin-right:auto; background:#fff; padding:10px; border-radius:8px; }
  table { margin:20px auto; border-collapse:collapse; background:#fff; }
  td, th { border:1px solid #999; padding:6px 10px; }
  #restartBtn { font-size:12px; margin-top:30px; }
</style>
</head>
<body>
<div id="faseCorrente">Fase attuale: -</div>

<div id="immagineFase"><img id="faseImg" src="preriscaldo.png" alt="fase" width="200"></div>

<div id="timer">Timer: 0s</div>
<div class="progress-container"><div id="progress" class="progress-bar"></div></div>
<div id="totalTimer" class="hidden"></div>

<button id="btnPreriscaldo" class="btn-dark">Avvia Preriscaldo</button>
<button id="btnColatura" class="btn-dark hidden">Avvia Colatura</button>
<div id="avviso" class="hidden"></div>
<button id="btnConferma" class="btn-red hidden">Conferma</button>

<div id="log"><h3>Orari delle Fasi</h3><div id="logContent"></div></div>

<table>
<tr><th>Fase</th><th>Tempo programmato</th><th>Tempo effettivo</th></tr>
<tr><td>Preriscaldo</td><td>1m45s</td><td id="effPreriscaldo">-</td></tr>
<tr><td>Colatura</td><td>30m</td><td id="effColatura">-</td></tr>
<tr><td>Tranciare</td><td>5m30s</td><td id="effTrancia">-</td></tr>
<tr><td>Smerigliatura</td><td>al termine</td><td id="effSmeriglia">-</td></tr>
</table>

<button id="restartBtn" class="btn-dark">Rinizia da capo</button>

<audio id="beep" src="beep.mp3" loop></audio>
<audio id="siren" src="siren.mp3" loop></audio>

<script>
let faseAttuale=null, faseDurata=0, faseStart=0, currentInterval=null;
let colaturaStartTime=null, totalColaturaTimer=null;
let tranciaTime = 330000; // 5m30s in ms
let tranciaConfermata=false;
const faseCorrenteEl=document.getElementById("faseCorrente");
const avvisoEl=document.getElementById("avviso");
const btnConferma=document.getElementById("btnConferma");
const totalTimerEl=document.getElementById("totalTimer");
const beep=document.getElementById("beep");
const siren=document.getElementById("siren");

// ---- LOG ----
function aggiornaLog(msg){
  let t=new Date();
  let orario = t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")+":"+t.getSeconds().toString().padStart(2,"0");
  document.getElementById("logContent").innerHTML += `[${orario}] ${msg}<br>`;
}

// ---- RIEPILOGO ----
function aggiornaTabella(fase,idCell){
  let tempoEff=Math.round((Date.now()-faseStart)/1000);
  let m = Math.floor(tempoEff/60), s = tempoEff % 60;
  document.getElementById(idCell).textContent = `${m}m${s}s`;
}

// ---- AVVISI ----
function mostraAvviso(msg, keepTimer=false){
  avvisoEl.textContent=msg;
  avvisoEl.classList.remove("hidden");
  btnConferma.classList.remove("hidden");
  faseConfermata=false;
  // audio
  beep.play().catch(()=>{});
}

function nascondiAvviso(keepTimer=false){
  avvisoEl.classList.add("hidden");
  btnConferma.classList.add("hidden");
  beep.pause(); beep.currentTime=0;
  siren.pause(); siren.currentTime=0;
  faseConfermata=true;
  if(!keepTimer){ clearInterval(currentInterval); }
}

// ---- TIMER GENERICI ----
function startFase(nome, durata){
  faseAttuale=nome;
  faseDurata=durata*1000;
  faseStart=Date.now();
  clearInterval(currentInterval);
  currentInterval=setInterval(updateTimer,1000);
  faseCorrenteEl.textContent="Fase attuale: "+nome.charAt(0).toUpperCase()+nome.slice(1);
  document.getElementById("faseImg").src=nome+".png";
}

function updateTimer(){
  let elapsed=Date.now()-faseStart;
  let remain=faseDurata-elapsed;
  if(remain<0) remain=0;
  let m=Math.floor(remain/60000), s=Math.floor((remain%60000)/1000);
  document.getElementById("timer").textContent=`Timer: ${m}m${s}s`;
  document.getElementById("progress").style.width=(elapsed/faseDurata*100)+"%";

  if(faseAttuale==="colatura"){
    let e = Date.now()-colaturaStartTime;
    if(!tranciaConfermata && e>=tranciaTime-15000 && e<tranciaTime){
      mostraAvviso("Preparati a TRANCIARE!",true);
    }
    if(!tranciaConfermata && e>=tranciaTime){
      mostraAvviso("TRANCIARE ora!",true);
      siren.play().catch(()=>{});
      faseCorrenteEl.textContent="Fase attuale: Tranciare";
      document.getElementById("faseImg").src="trancia.png";
    }
    if(e>=faseDurata-15000 && e<faseDurata){
      mostraAvviso("Preparati a SMERIGLIARE!",true);
    }
    if(e>=faseDurata){
      mostraAvviso("SMERIGLIARE ora!");
      siren.play().catch(()=>{});
      faseCorrenteEl.textContent="Fase attuale: Smerigliatura";
      document.getElementById("faseImg").src="smeriglia.png";
    }
  }
}

// ---- TOTAL TIMER COLATURA basato su orario reale ----
function startTotalColaturaTimer() {
  if (totalColaturaTimer) return;
  if (!colaturaStartTime) colaturaStartTime = Date.now();
  try { localStorage.setItem('colaturaStartTime', String(colaturaStartTime)); } catch(e){}
  updateTotalColatura();
  totalColaturaTimer = setInterval(updateTotalColatura, 1000);
  totalTimerEl.classList.remove("hidden");
}
function updateTotalColatura() {
  if (!colaturaStartTime) { totalTimerEl.textContent = `Tempo totale colatura: 0m0s`; return; }
  const elapsedSec = Math.floor((Date.now() - colaturaStartTime)/1000);
  const m = Math.floor(elapsedSec/60), s = elapsedSec % 60;
  totalTimerEl.textContent = `Tempo totale colatura: ${m}m${s}s`;
}
function stopTotalColaturaTimer() {
  if (totalColaturaTimer) {
    clearInterval(totalColaturaTimer);
    totalColaturaTimer = null;
  }
  try { localStorage.removeItem('colaturaStartTime'); } catch(e){}
}

// ---- EVENTI BOTTONI ----
document.getElementById("btnPreriscaldo").addEventListener("click",()=>{
  document.getElementById("btnPreriscaldo").classList.add("hidden");
  startFase("preriscaldo",105);
  aggiornaLog("Avviato Preriscaldo");
});
document.getElementById("btnColatura").addEventListener("click",()=>{
  document.getElementById("btnColatura").classList.add("hidden");
  startFase("colatura",1800);
  colaturaStartTime=Date.now();
  startTotalColaturaTimer();
  aggiornaLog("Avviata Colatura");
  document.getElementById("faseImg").src="colatura.png";
});
btnConferma.addEventListener("click",()=>{
  if(faseAttuale==="preriscaldo"){ 
    nascondiAvviso();
    aggiornaLog("Completato Preriscaldo"); 
    aggiornaTabella("Preriscaldo","effPreriscaldo"); 
    document.getElementById("btnColatura").classList.remove("hidden"); 
  }
  else if(faseAttuale==="colatura" && !tranciaConfermata && Date.now()-colaturaStartTime>=tranciaTime){ 
    tranciaConfermata=true;
    nascondiAvviso(true);
    aggiornaLog("âœ… TRANCIARE confermato"); 
    aggiornaTabella("Tranciare","effTrancia"); 
    faseCorrenteEl.textContent="Fase attuale: Colatura"; 
    document.getElementById("faseImg").src="colatura.png";
  }
  else if(faseAttuale==="colatura" && Date.now()-colaturaStartTime>=faseDurata){ 
    nascondiAvviso();
    aggiornaLog("Confermato SMERIGLIATURA"); 
    aggiornaTabella("Colatura","effColatura"); 
    aggiornaTabella("Smerigliatura","effSmeriglia"); 
    faseCorrenteEl.textContent="Fase attuale: Smerigliatura"; 
    stopTotalColaturaTimer();
  }
});
document.getElementById("restartBtn").addEventListener("click",()=>{
  if(confirm("Stai per resettare i tempi trascorsi fino ad ora, confermi di voler iniziare una nuova saldatura?")) {
    stopTotalColaturaTimer();
    location.href="index.html";
  }
});

// ripristina eventuale colatura
window.addEventListener('load',()=>{
  try {
    const saved=localStorage.getItem('colaturaStartTime');
    if(saved){ colaturaStartTime=Number(saved)||null; if(colaturaStartTime) startTotalColaturaTimer(); }
  } catch(e){}
});
</script>
</body>
</html>
